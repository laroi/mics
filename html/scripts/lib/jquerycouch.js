(function(e){function t(e){var t=e.split("/");if(t[0]=="_design"){t.shift();return"_design/"+encodeURIComponent(t.join("/"))}return encodeURIComponent(e)}function r(t,n,r,i){var s={contentType:"application/json",headers:{Accept:"application/json"}};n=e.extend({successStatus:200},n);i=e.extend(s,i);r=r||"Unknown error";e.ajax(e.extend(e.extend({type:"GET",dataType:"json",cache:!e.browser.msie,beforeSend:function(e){if(i&&i.headers){for(var t in i.headers){e.setRequestHeader(t,i.headers[t])}}},complete:function(t){try{var i=e.parseJSON(t.responseText)}catch(s){if(n.error){n.error(t.status,t,s)}else{throw r+": "+s}return}if(n.ajaxStart){n.ajaxStart(i)}if(t.status==n.successStatus){if(n.beforeSuccess)n.beforeSuccess(t,i);if(n.success)n.success(i)}else if(n.error){n.error(t.status,i&&i.error||r,i&&i.reason||"no response")}else{throw r+": "+i.reason}}},t),i))}function i(e){var e=e||{};if(typeof e.ensure_full_commit!=="undefined"){var t=e.ensure_full_commit;delete e.ensure_full_commit;return function(e){e.setRequestHeader("Accept","application/json");e.setRequestHeader("X-Couch-Full-Commit",t.toString())}}}function s(t){var n=[];if(typeof t==="object"&&t!==null){for(var r in t){if(e.inArray(r,["error","success","beforeSuccess","ajaxStart"])>=0)continue;var i=t[r];if(e.inArray(r,["key","startkey","endkey"])>=0){i=o(i)}n.push(encodeURIComponent(r)+"="+encodeURIComponent(i))}}return n.length?"?"+n.join("&"):""}function o(e){return e!==null?JSON.stringify(e):null}e.couch=e.couch||{};var n=[];e.extend(e.couch,{urlPrefix:"",activeTasks:function(e){r({url:this.urlPrefix+"/_active_tasks"},e,"Active task status could not be retrieved")},allDbs:function(e){r({url:this.urlPrefix+"/_all_dbs"},e,"An error occurred retrieving the list of all databases")},config:function(e,t,n,i){var s={url:this.urlPrefix+"/_config/"};if(t){s.url+=encodeURIComponent(t)+"/";if(n){s.url+=encodeURIComponent(n)}}if(i===null){s.type="DELETE"}else if(i!==undefined){s.type="PUT";s.data=o(i);s.contentType="application/json";s.processData=false}r(s,e,"An error occurred retrieving/updating the server configuration")},session:function(t){t=t||{};e.ajax({type:"GET",url:this.urlPrefix+"/_session",beforeSend:function(e){e.setRequestHeader("Accept","application/json")},complete:function(n){var r=e.parseJSON(n.responseText);if(n.status==200){if(t.success)t.success(r)}else if(t.error){t.error(n.status,r.error,r.reason)}else{throw"An error occurred getting session info: "+r.reason}}})},userDb:function(t){e.couch.session({success:function(n){var r=e.couch.db(n.info.authentication_db);t(r)}})},signup:function(t,n,r){r=r||{};t.password=n;t.roles=t.roles||[];t.type=t.type="user"||[];var i="org.couchdb.user:";t._id=t._id||i+t.name;e.couch.userDb(function(e){e.saveDoc(t,r)})},login:function(t){t=t||{};e.ajax({type:"POST",url:this.urlPrefix+"/_session",dataType:"json",data:{name:t.name,password:t.password},beforeSend:function(e){e.setRequestHeader("Accept","application/json")},complete:function(n){var r=e.parseJSON(n.responseText);if(n.status==200){if(t.success)t.success(r)}else if(t.error){t.error(n.status,r.error,r.reason)}else{throw"An error occurred logging in: "+r.reason}}})},logout:function(t){t=t||{};e.ajax({type:"DELETE",url:this.urlPrefix+"/_session",dataType:"json",username:"_",password:"_",beforeSend:function(e){e.setRequestHeader("Accept","application/json")},complete:function(n){var r=e.parseJSON(n.responseText);if(n.status==200){if(t.success)t.success(r)}else if(t.error){t.error(n.status,r.error,r.reason)}else{throw"An error occurred logging out: "+r.reason}}})},db:function(n,u){function f(e){if(e._id&&e._rev&&a[e._id]&&a[e._id].rev==e._rev){if(typeof Base64=="undefined"){throw"Base64 support not found."}else{e._attachments=e._attachments||{};e._attachments["rev-"+e._rev.split("-")[0]]={content_type:"application/json",data:Base64.encode(a[e._id].raw)};return true}}}u=u||{};var a={};return{name:n,uri:this.urlPrefix+"/"+encodeURIComponent(n)+"/",compact:function(t){e.extend(t,{successStatus:202});r({type:"POST",url:this.uri+"_compact",data:"",processData:false},t,"The database could not be compacted")},viewCleanup:function(t){e.extend(t,{successStatus:202});r({type:"POST",url:this.uri+"_view_cleanup",data:"",processData:false},t,"The views could not be cleaned up")},compactView:function(t,n){e.extend(n,{successStatus:202});r({type:"POST",url:this.uri+"_compact/"+t,data:"",processData:false},n,"The view could not be compacted")},create:function(t){e.extend(t,{successStatus:201});r({type:"PUT",url:this.uri,contentType:"application/json",data:"",processData:false},t,"The database could not be created")},drop:function(e){r({type:"DELETE",url:this.uri},e,"The database could not be deleted")},info:function(e){r({url:this.uri},e,"Database information could not be retrieved")},changes:function(t,n){function l(t){e.each(a,function(){this(t)})}function c(){var i=e.extend({heartbeat:10*1e3},n,{feed:"longpoll",since:t});r({url:o.uri+"_changes"+s(i)},n,"Error connecting to "+o.uri+"/_changes.")}n=n||{};var i=100,o=this,u=true,a=[],f={onChange:function(e){a.push(e)},stop:function(){u=false}};n.success=function(e){i=100;if(u){t=e.last_seq;l(e);c()}};n.error=function(){if(u){setTimeout(c,i);i=i*2}};if(t){c()}else{o.info({success:function(e){t=e.update_seq;c()}})}return f},allDocs:function(e){var t="GET";var n=null;if(e["keys"]){t="POST";var i=e["keys"];delete e["keys"];n=o({keys:i})}r({type:t,data:n,url:this.uri+"_all_docs"+s(e)},e,"An error occurred retrieving a list of all documents")},allDesignDocs:function(t){this.allDocs(e.extend({startkey:"_design",endkey:"_design0"},t))},allApps:function(t){t=t||{};var r=this;if(t.eachApp){this.allDesignDocs({success:function(i){e.each(i.rows,function(){r.openDoc(this.id,{success:function(e){var r,i,s=e._id.split("/");s.shift();s=s.join("/");r=e.couchapp&&e.couchapp.index;if(r){i=["",n,e._id,r].join("/")}else if(e._attachments&&e._attachments["index.html"]){i=["",n,e._id,"index.html"].join("/")}if(i)t.eachApp(s,i,e)}})})}})}else{throw"Please provide an eachApp function for allApps()"}},openDoc:function(n,i,o){i=i||{};if(u.attachPrevRev||i.attachPrevRev){e.extend(i,{beforeSuccess:function(e,t){a[t._id]={rev:t._rev,raw:e.responseText}}})}else{e.extend(i,{beforeSuccess:function(e,t){if(t["jquery.couch.attachPrevRev"]){a[t._id]={rev:t._rev,raw:e.responseText}}}})}r({url:this.uri+t(n)+s(i)},i,"The document could not be retrieved",o)},saveDoc:function(n,r){r=r||{};var u=this;var a=i(r);if(n._id===undefined){var l="POST";var c=this.uri}else{var l="PUT";var c=this.uri+t(n._id)}var h=f(n);e.ajax({type:l,url:c+s(r),contentType:"application/json",dataType:"json",data:o(n),beforeSend:a,complete:function(t){var i=e.parseJSON(t.responseText);if(t.status==200||t.status==201||t.status==202){n._id=i.id;n._rev=i.rev;if(h){u.openDoc(n._id,{attachPrevRev:true,success:function(e){n._attachments=e._attachments;if(r.success)r.success(i)}})}else{if(r.success)r.success(i)}}else if(r.error){r.error(t.status,i.error,i.reason)}else{throw"The document could not be saved: "+i.reason}}})},bulkSave:function(t,n){var u=i(n);e.extend(n,{successStatus:201,beforeSend:u});r({type:"POST",url:this.uri+"_bulk_docs"+s(n),contentType:"application/json",data:o(t)},n,"The documents could not be saved")},removeDoc:function(e,n){r({type:"DELETE",url:this.uri+t(e._id)+s({rev:e._rev})},n,"The document could not be deleted")},bulkRemove:function(t,n){t.docs=e.each(t.docs,function(e,t){t._deleted=true});e.extend(n,{successStatus:201});r({type:"POST",url:this.uri+"_bulk_docs"+s(n),data:o(t)},n,"The documents could not be deleted")},copyDoc:function(n,i,s){s=e.extend(s,{complete:function(t){var n=e.parseJSON(t.responseText);if(t.status==201){if(i.success)i.success(n)}else if(i.error){i.error(t.status,n.error,n.reason)}else{throw"The document could not be copied: "+n.reason}}});r({type:"COPY",url:this.uri+t(n)},i,"The document could not be copied",s)},query:function(e,t,n,i){n=n||"javascript";if(typeof e!=="string"){e=e.toSource?e.toSource():"("+e.toString()+")"}var u={language:n,map:e};if(t!=null){if(typeof t!=="string")t=t.toSource?t.toSource():"("+t.toString()+")";u.reduce=t}r({type:"POST",url:this.uri+"_temp_view"+s(i),contentType:"application/json",data:o(u)},i,"An error occurred querying the database")},list:function(e,t,n,i){var e=e.split("/");var n=n||{};var u="GET";var a=null;if(n["keys"]){u="POST";var f=n["keys"];delete n["keys"];a=o({keys:f})}r({type:u,data:a,url:this.uri+"_design/"+e[0]+"/_list/"+e[1]+"/"+t+s(n)},i,"An error occured accessing the list")},view:function(e,t){var e=e.split("/");var t=t||{};var n="GET";var i=null;if(t["keys"]){n="POST";var u=t["keys"];delete t["keys"];i=o({keys:u})}r({type:n,data:i,url:this.uri+"_design/"+e[0]+"/_view/"+e[1]+s(t)},t,"An error occurred accessing the view")},getDbProperty:function(e,t,n){r({url:this.uri+e+s(t)},t,"The property could not be retrieved",n)},setDbProperty:function(e,t,n,i){r({type:"PUT",url:this.uri+e+s(n),data:JSON.stringify(t)},n,"The property could not be updated",i)}}},encodeDocId:t,info:function(e){r({url:this.urlPrefix+"/"},e,"Server information could not be retrieved")},replicate:function(t,n,i,s){s=e.extend({source:t,target:n},s);if(s.continuous&&!s.cancel){i.successStatus=202}r({type:"POST",url:this.urlPrefix+"/_replicate",data:JSON.stringify(s),contentType:"application/json"},i,"Replication failed")},newUUID:function(e){if(e===undefined){e=1}if(!n.length){r({url:this.urlPrefix+"/_uuids",data:{count:e},async:false},{success:function(e){n=e.uuids}},"Failed to retrieve UUID batch.")}return n.shift()}});})(jQuery)